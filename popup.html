/**
 * ToolScout Premium Popup Script
 * Enhanced with smooth animations and modern interactions
 */

document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const searchInput = document.getElementById('searchInput');
  const searchButton = document.getElementById('searchButton');
  const resultsSection = document.getElementById('resultsSection');
  const resultsList = document.getElementById('resultsList');
  const currentProductSection = document.getElementById('currentProductSection');
  const compareButton = document.getElementById('compareButton');
  const tabs = document.querySelectorAll('.tab');
  const searchSection = document.getElementById('searchSection');
  const alertSection = document.getElementById('alertSection');
  const alertsList = document.getElementById('alertsList');
  const alertPriceInput = document.getElementById('alertPriceInput');
  const setAlertButton = document.getElementById('setAlertButton');
  const settingsBtn = document.getElementById('settingsBtn');
  
  let currentProduct = null;
  let currentSearchResults = [];

  // Initialize
  init();

  function init() {
    checkCurrentPage();
    loadAlerts();
    setupEventListeners();
    animateEntrance();
  }

  // =================================================================================================
  // Animations
  // =================================================================================================

  function animateEntrance() {
    // Add slide-in animation to cards on load
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
      setTimeout(() => {
        card.classList.add('slide-in');
      }, index * 100);
    });
  }

  // =================================================================================================
  // Event Listeners
  // =================================================================================================

  function setupEventListeners() {
    // Tab switching with smooth transitions
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        switchTab(tabName);
      });
    });

    // Search functionality
    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    // Compare button
    if (compareButton) {
      compareButton.addEventListener('click', compareCurrentProduct);
    }

    // Alert functionality
    if (setAlertButton) {
      setAlertButton.addEventListener('click', setNewAlert);
    }

    // Settings button
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        chrome.runtime.openOptionsPage();
      });
    }
  }

  // =================================================================================================
  // Tab Management
  // =================================================================================================

  function switchTab(tabName) {
    // Update active tab
    tabs.forEach(t => {
      t.classList.remove('active');
      if (t.dataset.tab === tabName) {
        t.classList.add('active');
      }
    });

    // Hide all sections with fade effect
    const sections = [searchSection, alertSection, currentProductSection];
    sections.forEach(section => {
      if (section) {
        section.classList.add('hidden');
      }
    });

    // Show appropriate section with animation
    setTimeout(() => {
      switch(tabName) {
        case 'search':
          searchSection.classList.remove('hidden');
          searchSection.classList.add('slide-in');
          resultsSection.classList.remove('hidden');
          break;
        case 'alerts':
          alertSection.classList.remove('hidden');
          alertSection.classList.add('slide-in');
          loadAlerts();
          break;
        case 'current':
          if (currentProduct) {
            currentProductSection.classList.remove('hidden');
            currentProductSection.classList.add('slide-in');
          } else {
            currentProductSection.classList.remove('hidden');
            currentProductSection.classList.add('slide-in');
            document.getElementById('currentTitle').textContent = 'No product detected on current page';
            document.getElementById('currentPrice').textContent = '--';
            if (compareButton) compareButton.style.display = 'none';
          }
          break;
      }
    }, 100);
  }

  // =================================================================================================
  // Current Page Detection
  // =================================================================================================

  async function checkCurrentPage() {
    try {
      const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
      const url = tab.url;
      
      // Check if we're on a supported retailer
      const supportedSites = ['amazon.com', 'homedepot.com', 'leroymerlin.fr', 'ebay.com'];
      const isSupported = supportedSites.some(site => url.includes(site));
      
      if (isSupported) {
        // Try to get product info from storage
        chrome.storage.local.get(['currentProduct'], (result) => {
          if (result.currentProduct && result.currentProduct.url === url) {
            currentProduct = result.currentProduct;
            displayCurrentProduct();
          } else {
            // Inject content script to extract product info
            chrome.tabs.sendMessage(tab.id, { action: 'extractProduct' }, (response) => {
              if (response && response.success) {
                currentProduct = response.data;
                displayCurrentProduct();
              }
            });
          }
        });
      }
    } catch (error) {
      console.error('Error checking current page:', error);
    }
  }

  function displayCurrentProduct() {
    if (!currentProduct) return;
    
    document.getElementById('currentTitle').textContent = currentProduct.title || 'Product detected';
    document.getElementById('currentPrice').textContent = currentProduct.price ? `$${currentProduct.price}` : 'Price unavailable';
    
    const retailerBadge = document.getElementById('currentRetailer');
    retailerBadge.textContent = currentProduct.retailer.toUpperCase();
    retailerBadge.className = `retailer-badge retailer-${currentProduct.retailer}`;
    
    if (compareButton) compareButton.style.display = 'block';
  }

  // =================================================================================================
  // Search Functionality
  // =================================================================================================

  async function performSearch() {
    const query = searchInput.value.trim();
    if (!query) {
      showError('Please enter a search term');
      return;
    }
    
    searchButton.disabled = true;
    searchButton.innerHTML = '<span>Searching...</span>';
    
    // Show loading state
    resultsSection.classList.remove('hidden');
    resultsList.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Searching all retailers...</div>
      </div>
    `;
    
    try {
      // Search eBay (as implemented)
      const response = await chrome.runtime.sendMessage({
        action: 'searchEbay',
        keyword: query,
        options: {
          limit: 10,
          condition: 'New',
          sortBy: 'PricePlusShippingLowest'
        }
      });
      
      if (response.success) {
        currentSearchResults = response.data;
        displayResults(response.data);
      } else {
        showError('Search failed. Please try again.');
      }
    } catch (error) {
      console.error('Search error:', error);
      showError('An error occurred during search.');
    } finally {
      searchButton.disabled = false;
      searchButton.innerHTML = '<span>Search All Retailers</span>';
    }
  }

  async function compareCurrentProduct() {
    if (!currentProduct) return;
    
    compareButton.disabled = true;
    compareButton.innerHTML = '<span>Comparing...</span>';
    
    // Show loading state
    resultsSection.classList.remove('hidden');
    resultsList.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Finding best prices...</div>
      </div>
    `;
    
    try {
      // Extract brand and product name from title
      const title = currentProduct.title || '';
      const words = title.split(' ');
      const brand = words[0]; // Simple brand extraction
      const productName = words.slice(1, 4).join(' '); // Take next few words
      
      const response = await chrome.runtime.sendMessage({
        action: 'compareAllPrices',
        productName: productName,
        brand: brand
      });
      
      if (response.success && response.data.alternatives) {
        displayResults(response.data.alternatives);
      } else {
        showError('No alternatives found.');
      }
    } catch (error) {
      console.error('Comparison error:', error);
      showError('Failed to compare prices.');
    } finally {
      compareButton.disabled = false;
      compareButton.innerHTML = '<span>Compare Prices Across All Stores</span>';
    }
  }

  // =================================================================================================
  // Results Display
  // =================================================================================================

  function displayResults(results) {
    if (!results || results.length === 0) {
      resultsList.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">üîç</div>
          <div>No results found. Try a different search term.</div>
        </div>
      `;
      return;
    }
    
    // Sort by total price (price + shipping)
    results.sort((a, b) => (a.price + a.shipping) - (b.price + b.shipping));
    
    let html = '';
    results.forEach((item, index) => {
      const totalPrice = item.price + item.shipping;
      const isBestDeal = index === 0;
      
      html += `
        <div class="result-item" data-url="${item.url}">
          ${isBestDeal ? '<div class="best-deal">Best Deal</div>' : ''}
          <div class="result-header-row">
            <div>
              <span class="retailer-badge retailer-ebay">
                <span>üì¶</span>
                <span>eBay</span>
              </span>
            </div>
            <div class="result-price">$${totalPrice.toFixed(2)}</div>
          </div>
          <div class="result-title">${item.title}</div>
          <div class="result-details">
            <span class="detail-badge">
              <span>‚úÖ</span>
              <span>${item.condition}</span>
            </span>
            <span class="detail-badge shipping-badge">
              <span>üì¶</span>
              <span>${item.shipping > 0 ? `+$${item.shipping.toFixed(2)} shipping` : 'Free shipping'}</span>
            </span>
            ${item.seller ? `
              <span class="detail-badge">
                <span>‚≠ê</span>
                <span>${item.seller.rating}%</span>
              </span>
            ` : ''}
          </div>
        </div>
      `;
    });
    
    resultsList.innerHTML = html;
    
    // Add smooth entrance animation
    const items = document.querySelectorAll('.result-item');
    items.forEach((item, index) => {
      setTimeout(() => {
        item.classList.add('slide-in');
      }, index * 50);
    });
    
    // Add click handlers to open items
    items.forEach(item => {
      item.addEventListener('click', () => {
        const url = item.dataset.url;
        if (url) chrome.tabs.create({ url });
      });
    });
  }

  function showError(message) {
    resultsList.innerHTML = `
      <div class="no-results">
        <div class="no-results-icon">‚ö†Ô∏è</div>
        <div>${message}</div>
      </div>
    `;
  }

  // =================================================================================================
  // Price Alerts
  // =================================================================================================

  async function loadAlerts() {
    const response = await chrome.runtime.sendMessage({ action: 'getAlerts' });
    
    if (response.success && response.alerts.length > 0) {
      displayAlerts(response.alerts);
    } else {
      alertsList.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">üîî</div>
          <div>No price alerts set. Search for a product and set your target price!</div>
        </div>
      `;
    }
  }

  function displayAlerts(alerts) {
    let html = '';
    alerts.forEach(alert => {
      const statusText = alert.triggered ? 
        `‚úÖ Triggered at $${alert.triggeredPrice}` : 
        `‚è∞ Watching for $${alert.targetPrice}`;
      
    html += `
  <div class="alert-item">
    <button class="delete-alert" data-id="${alert.id}">√ó</button>
    <div class="alert-product-name">
      ${alert.productName}
    </div>
    <div class="alert-product-status">
      ${statusText} ‚Ä¢ Created ${new Date(alert.createdAt).toLocaleDateString()}
    </div>
  </div>
`;
    });
    
    alertsList.innerHTML = html;
    
    // Add delete handlers
    document.querySelectorAll('.delete-alert').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const alertId = btn.dataset.id;
        
        // Add rotation animation before delete
        btn.classList.add('rotating'); // instead of btn.style.transform = ...
        
        setTimeout(async () => {
          await chrome.runtime.sendMessage({ 
            action: 'deleteAlert', 
            alertId 
          });
          loadAlerts();
        }, 300);
      });
    });
  }

  async function setNewAlert() {
    const targetPrice = parseFloat(alertPriceInput.value);
    const productName = searchInput.value.trim() || (currentProduct && currentProduct.title);
    
    if (!productName || !targetPrice) {
      showNotification('Please enter a product name and target price', 'error');
      return;
    }
    
    setAlertButton.disabled = true;
    setAlertButton.textContent = 'Setting Alert...';
    
    const response = await chrome.runtime.sendMessage({
      action: 'saveAlert',
      data: {
        productName,
        targetPrice,
        currentPrice: currentProduct ? currentProduct.price : null,
        retailer: 'all'
      }
    });
    
    if (response.success) {
      alertPriceInput.value = '';
      showNotification(`Price alert set! We'll notify you when ${productName} drops below $${targetPrice}`, 'success');
      loadAlerts();
    } else {
      showNotification(response.error || 'Failed to set alert', 'error');
    }
    
    setAlertButton.disabled = false;
    setAlertButton.textContent = 'Set Price Alert';
  }

  // =================================================================================================
  // Utility Functions
  // =================================================================================================

 function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.classList.add('slide-up');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
});